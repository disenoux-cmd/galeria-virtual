<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Galería de la Propaganda</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Montserrat', sans-serif;
            color: #f0f0f0;
        }

        #blocker {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(10,10,10,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            text-align: center;
            transition: opacity 0.5s;
        }

        #instructions {
            width: 700px;
            max-width: 90%;
            background: rgba(25,25,25,0.9);
            padding: 40px;
            border: 1px solid #444;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            border-radius: 8px;
        }

        h1 {
            font-weight: 300;
            letter-spacing: 5px;
            text-transform: uppercase;
            margin-bottom: 10px;
            color: #ffcc00;
            border-bottom: 1px solid #444;
            padding-bottom: 20px;
        }

        p {
            font-size: 16px;
            line-height: 1.6;
            color: #ccc;
        }

        /* Loading Bar */
        #loading-bar-container {
            width: 100%;
            height: 4px;
            background: #333;
            margin-top: 20px;
            border-radius: 2px;
            overflow: hidden;
        }
        #loading-bar {
            width: 0%;
            height: 100%;
            background: #ffcc00;
            transition: width 0.3s;
        }

        .btn {
            background: transparent;
            border: 2px solid #fff;
            color: #fff;
            padding: 15px 40px;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 3px;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.3s;
            font-weight: bold;
            opacity: 0.5;
            pointer-events: none;
        }
        
        .btn.active {
            opacity: 1;
            pointer-events: auto;
            background: #ffcc00;
            color: #000;
            border-color: #ffcc00;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px #ffcc00;
        }

        #crosshair {
            position: absolute;
            top: 50%; left: 50%;
            width: 8px; height: 8px;
            background: white; border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; z-index: 5;
            mix-blend-mode: difference;
        }

        #interact-msg {
            position: absolute;
            top: 60%; left: 50%;
            transform: translateX(-50%);
            font-size: 16px; color: #fff;
            background: rgba(0,0,0,0.6);
            padding: 8px 16px; border-radius: 20px;
            opacity: 0; transition: opacity 0.2s;
            pointer-events: none; z-index: 5;
            border: 1px solid rgba(255,255,255,0.2);
        }

        #info-modal, #final-ui {
            display: none; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 20; background: rgba(20, 20, 20, 0.98);
            border: 1px solid #444; padding: 40px;
            max-width: 90%; box-shadow: 0 0 50px black;
        }
        
        #final-ui {
            width: 100%; height: 100%;
            top: 0; left: 0; transform: none;
            flex-direction: column; align-items: center; justify-content: center;
            background: rgba(10,10,10,0.95);
        }

        #info-modal h2 { color: #ffcc00; margin-top: 0; }
        #info-modal .close-btn { 
            position: absolute; top: 15px; right: 20px; 
            font-size: 24px; cursor: pointer; color: #666; background:none; border:none;
        }
        #info-modal .close-btn:hover { color: #fff; }

        .card-container { display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap; justify-content: center; }
        .choice-card {
            background: #222; border: 1px solid #444; padding: 20px; width: 220px;
            cursor: pointer; transition: 0.3s; text-align: center;
        }
        .choice-card:hover { border-color: #ffcc00; transform: translateY(-5px); background: #333; }
        .choice-card h3 { color: #fff; margin: 10px 0; font-size: 18px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
</head>
<body>

    <div id="crosshair"></div>
    <div id="interact-msg">Click para interactuar</div>

    <!-- PANTALLA DE INICIO WEB -->
    <div id="blocker">
        <div id="instructions">
            <h1>La Galería de la Propaganda</h1>
            <p>
                Bienvenido, detective. <br>
                La propaganda busca influir en tus emociones. Explora las 3 salas, analiza las técnicas y elige una pieza final.
            </p>
            
            <div id="loading-bar-container">
                <div id="loading-bar"></div>
            </div>
            <p id="loading-text" style="font-size: 12px; color: #888; margin-top: 10px;">Cargando recursos...</p>

            <button class="btn" id="start-btn">ENTRAR AL MUSEO</button>
        </div>
    </div>

    <!-- MODAL INFO -->
    <div id="info-modal">
        <button class="close-btn">&times;</button>
        <h2 id="modal-title">Título</h2>
        <div id="modal-content"></div>
        <button class="btn active" id="modal-close-main" style="margin-top:20px; width:100%; padding: 10px;">Cerrar</button>
    </div>

    <!-- UI FINAL -->
    <div id="final-ui">
        <h1>Análisis Final</h1>
        <p>¿Qué estrategia fue más efectiva?</p>
        <div class="card-container">
            <div class="choice-card" onclick="selectFinal('Rosie')">
                <h3>Rosie</h3><p style="font-size:12px; color:#888;">Patriotismo</p>
            </div>
            <div class="choice-card" onclick="selectFinal('Cola')">
                <h3>Coca-Cola</h3><p style="font-size:12px; color:#888;">Emoción</p>
            </div>
            <div class="choice-card" onclick="selectFinal('Politica')">
                <h3>Arturo</h3><p style="font-size:12px; color:#888;">Miedo</p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN DE IMÁGENES (EDITA ESTO) ---
        // Coloca aquí los enlaces (URLs) directos a tus imágenes en internet.
        // Si el enlace falla, el juego generará una versión automática de respaldo.
        const IMG_URLS = {
            rosie: 'https://upload.wikimedia.org/wikipedia/commons/1/12/We_Can_Do_It%21.jpg', 
            coca: 'https://images.unsplash.com/photo-1527529482837-4698179dc6ce?auto=format&fit=crop&w=500&q=80', // Ejemplo: Fiesta genérica
            politica: 'https://images.unsplash.com/photo-1541829070764-84a7d30dd3f3?auto=format&fit=crop&w=500&q=80' // Ejemplo: Hombre serio/oscuro
        };

        // --- THREE.JS APP ---
        let camera, scene, renderer, controls, raycaster;
        let moveFwd = false, moveBwd = false, moveLeft = false, moveRight = false;
        let prevTime = performance.now();
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        
        const hotspots = [];
        let isModalOpen = false;
        let exitUnlocked = false;
        let visited = { 1: false, 2: false, 3: false };
        let exitMesh = null;
        let artMeshes = {}; 
        let loadedCount = 0;

        const textureLoader = new THREE.TextureLoader();
        // Permite cargar imágenes de otros dominios (CORS)
        textureLoader.crossOrigin = "Anonymous"; 

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111111);
            scene.fog = new THREE.Fog(0x111111, 0, 40);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.y = 1.6;

            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            controls = new THREE.PointerLockControls(camera, document.body);

            // Pre-cargar imágenes antes de dejar entrar al usuario
            preloadImages();

            // Listener de Inicio
            const startBtn = document.getElementById('start-btn');
            startBtn.addEventListener('click', () => {
                if(startBtn.classList.contains('active')) {
                    controls.lock();
                }
            });

            controls.addEventListener('lock', () => {
                if(!isModalOpen && !exitUnlocked) document.getElementById('blocker').style.display = 'none';
            });
            controls.addEventListener('unlock', () => {
                if(!isModalOpen && !exitUnlocked) document.getElementById('blocker').style.display = 'flex';
            });

            // Teclado
            const onKey = (e, val) => {
                switch(e.code) {
                    case 'KeyW': case 'ArrowUp': moveFwd = val; break;
                    case 'KeyS': case 'ArrowDown': moveBwd = val; break;
                    case 'KeyA': case 'ArrowLeft': moveLeft = val; break;
                    case 'KeyD': case 'ArrowRight': moveRight = val; break;
                }
            };
            document.addEventListener('keydown', (e) => onKey(e, true));
            document.addEventListener('keyup', (e) => onKey(e, false));

            raycaster = new THREE.Raycaster();
            document.addEventListener('mousedown', onMouseClick);
            
            document.querySelector('.close-btn').addEventListener('click', closeModal);
            document.getElementById('modal-close-main').addEventListener('click', closeModal);
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            buildWorld();
        }

        function preloadImages() {
            const keys = Object.keys(IMG_URLS);
            let total = keys.length;
            let current = 0;

            const updateProgress = () => {
                current++;
                const pct = (current / total) * 100;
                document.getElementById('loading-bar').style.width = pct + '%';
                if(current >= total) {
                    document.getElementById('loading-text').innerText = "¡Listo para explorar!";
                    document.getElementById('start-btn').classList.add('active');
                }
            };

            // Intentar cargar cada URL
            keys.forEach(key => {
                textureLoader.load(
                    IMG_URLS[key],
                    // Success
                    (tex) => {
                        if(artMeshes[key]) artMeshes[key].material.map = tex;
                        updateProgress();
                    },
                    // Progress
                    undefined,
                    // Error (Usar Canvas Fallback)
                    () => {
                        console.log(`Fallback usado para ${key}`);
                        // No hace nada, ya que el canvas generado es el defecto. Solo actualiza progreso.
                        updateProgress();
                    }
                );
            });
        }

        function buildWorld() {
            // Suelo
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(60,60), new THREE.MeshStandardMaterial({color: 0x222222, roughness: 0.8}));
            floor.rotation.x = -Math.PI/2;
            scene.add(floor);

            // Paredes
            const wallMat = new THREE.MeshStandardMaterial({color: 0x333333});
            createWall(0, 3, -10, 20, 6, 1, wallMat); // Frente
            createWall(0, 3, 10, 20, 6, 1, wallMat); // Atras
            createWall(-10, 3, 0, 1, 6, 20, wallMat); // Izq
            createWall(10, 3, 0, 1, 6, 20, wallMat); // Der
            createWall(0, 6, 0, 20, 1, 20, new THREE.MeshBasicMaterial({color:0x111111})); // Techo

            // --- OBRAS (Se inician con versión generada, luego se actualizan al cargar URL) ---
            
            // 1. Rosie
            createArtDisplay(
                { text: "We Can Do It!", color: "#FFCC00" },
                new THREE.Vector3(-9.4, 2, -5), Math.PI/2, 'rosie', {w:2.2, h:3}
            );
            createHotspot(new THREE.Vector3(-9, 2.5, -5.5), "El Músculo", "Símbolo de fuerza femenina.", 1);
            createHotspot(new THREE.Vector3(-9, 3.2, -5), "El Lema", "'We' (Nosotras) implica unidad colectiva.", 1);

            // 2. Coca-Cola
            createArtDisplay(
                { text: "DESTAPA FELICIDAD", color: "#CC0000" },
                new THREE.Vector3(0, 2, -9.4), 0, 'coca', {w:2.5, h:3.5}
            );
            createHotspot(new THREE.Vector3(-0.8, 2.5, -9), "Fiesta", "Venta de pertenencia social.", 2);
            createHotspot(new THREE.Vector3(0.8, 1.5, -9), "Producto", "La botella como llave a la felicidad.", 2);

            // 3. Política
            createArtDisplay(
                { text: "¡PELIGRO: ARTURO!", color: "#550000" },
                new THREE.Vector3(9.4, 2, 5), -Math.PI/2, 'politica', {w:2.2, h:3.2}
            );
            createHotspot(new THREE.Vector3(9, 3, 5), "Miedo", "Palabras alarmistas para paralizar la lógica.", 3);
            createHotspot(new THREE.Vector3(9, 2, 5.5), "Rostro", "Foto manipulada para generar rechazo.", 3);

            // Salida
            createExit();
        }

        function createWall(x,y,z,w,h,d,mat) {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), mat);
            mesh.position.set(x,y,z);
            scene.add(mesh);
        }

        function createArtDisplay(fallbackData, pos, rotY, id, size) {
            // Marco
            const frame = new THREE.Mesh(new THREE.BoxGeometry(size.w+0.2, size.h+0.2, 0.1), new THREE.MeshStandardMaterial({color:0x111111}));
            frame.position.copy(pos);
            frame.rotation.y = rotY;
            scene.add(frame);

            // Lienzo (Placeholder generado por código por defecto)
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 700;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = fallbackData.color; ctx.fillRect(0,0,512,700);
            ctx.fillStyle = "white"; ctx.font="bold 40px Arial"; ctx.textAlign="center"; 
            ctx.fillText(fallbackData.text, 256, 350);
            
            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.MeshBasicMaterial({map: tex});
            const mesh = new THREE.Mesh(new THREE.PlaneGeometry(size.w, size.h), mat);
            
            // Posicionar
            mesh.position.copy(pos);
            mesh.rotation.y = rotY;
            const offset = new THREE.Vector3(0,0,0.06).applyAxisAngle(new THREE.Vector3(0,1,0), rotY);
            mesh.position.add(offset);
            scene.add(mesh);
            
            artMeshes[id] = mesh; // Guardar referencia para actualizar cuando cargue la URL

            // Luz
            const spot = new THREE.SpotLight(0xffffff, 2);
            spot.position.set(pos.x - Math.sin(rotY)*4, 5, pos.z + Math.cos(rotY)*4);
            spot.target = mesh;
            spot.angle = 0.5; spot.penumbra = 0.5;
            scene.add(spot);
        }

        function createHotspot(pos, title, desc, roomId) {
            const mesh = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({color: 0x00ffcc}));
            mesh.position.copy(pos);
            mesh.userData = {type:'hotspot', title, desc, roomId};
            scene.add(mesh);
            hotspots.push(mesh);
        }

        function createExit() {
            const geo = new THREE.BoxGeometry(2,3,0.1);
            const mat = new THREE.MeshStandardMaterial({color: 0x00ff00, emissive: 0x004400});
            exitMesh = new THREE.Mesh(geo, mat);
            exitMesh.position.set(0, 1.5, 9);
            exitMesh.visible = false;
            exitMesh.userData = {type:'exit'};
            scene.add(exitMesh);
        }

        // --- LÓGICA DE JUEGO ---
        function onMouseClick() {
            if(!controls.isLocked) return;
            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = raycaster.intersectObjects(scene.children);
            if(hits.length > 0) {
                const obj = hits[0].object;
                if(obj.userData.type === 'hotspot') {
                    openModal(obj.userData.title, obj.userData.desc);
                    visited[obj.userData.roomId] = true;
                    checkExit();
                } else if(obj.userData.type === 'exit' && exitMesh.visible) {
                    document.exitPointerLock();
                    document.getElementById('final-ui').style.display = 'flex';
                    exitUnlocked = true;
                }
            }
        }

        function openModal(title, content) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerText = content;
            document.getElementById('info-modal').style.display = 'block';
            isModalOpen = true;
            document.exitPointerLock();
        }

        function closeModal() {
            document.getElementById('info-modal').style.display = 'none';
            isModalOpen = false;
            controls.lock();
        }

        function checkExit() {
            if(visited[1] && visited[2] && visited[3]) {
                exitMesh.visible = true;
            }
        }

        window.selectFinal = (choice) => {
            alert("Has seleccionado: " + choice + ". ¡Buen trabajo!");
            location.reload();
        };

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            
            if(controls.isLocked) {
                const delta = (time - prevTime) / 1000;
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                direction.z = Number(moveFwd) - Number(moveBwd);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                if (moveFwd || moveBwd) velocity.z -= direction.z * 40.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 40.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                // Raycast para UI
                raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
                const hits = raycaster.intersectObjects(scene.children);
                const msg = document.getElementById('interact-msg');
                let hover = false;
                if(hits.length > 0 && hits[0].distance < 4) {
                    if(hits[0].object.userData.type === 'hotspot') hover = true;
                    if(hits[0].object.userData.type === 'exit' && exitMesh.visible) {
                        hover = true; msg.innerText = "Click para SALIR";
                    } else msg.innerText = "Click para interactuar";
                }
                msg.style.opacity = hover ? 1 : 0;
            }
            prevTime = time;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
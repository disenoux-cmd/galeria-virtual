<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Galer√≠a de la Propaganda</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&family=Roboto+Slab:wght@300;400;700&family=Orbitron:wght@400;700&display=swap');

        /* Reset b√°sico para evitar desbordes */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Montserrat', sans-serif;
            color: #f0f0f0;
        }

        /* --- HUD GAMER --- */
        #hud-container {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 300px;
            padding: 15px;
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid #00ccff;
            border-left: 5px solid #00ccff;
            z-index: 5;
            font-family: 'Orbitron', sans-serif;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 90% 100%, 0 100%);
            transition: all 0.3s;
        }

        #hud-title {
            font-size: 12px;
            color: #00ccff;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        #hud-counter {
            font-size: 24px;
            color: #fff;
            font-weight: bold;
        }

        #hud-bar-bg {
            width: 100%;
            height: 8px;
            background: #111;
            margin-top: 10px;
            border-radius: 4px;
            overflow: hidden;
        }

        #hud-bar-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #00ccff, #00ff99);
            box-shadow: 0 0 10px #00ff99;
            transition: width 0.5s cubic-bezier(0.1, 1.5, 0.6, 1);
        }

        #exit-notification {
            position: absolute;
            top: 15%;
            width: 100%;
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            color: #00ff00;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 0 0 20px #00ff00;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 6;
        }

        /* --- PANTALLAS Y MEN√öS --- */
        #blocker {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(10,10,10,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            text-align: center;
            transition: opacity 0.5s;
            padding: 20px; /* Margen seguro en m√≥viles */
        }

        #instructions {
            width: 800px;
            max-width: 100%;
            background: rgba(25,25,25,0.95);
            padding: 40px;
            border: 1px solid #444;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            border-radius: 8px;
        }

        h1 {
            font-weight: 300;
            letter-spacing: 5px;
            text-transform: uppercase;
            margin-bottom: 10px;
            color: #ffcc00;
            border-bottom: 1px solid #444;
            padding-bottom: 20px;
            /* Ajuste din√°mico de fuente para evitar cortes */
            font-size: clamp(1.5rem, 4vw, 2.5rem); 
            line-height: 1.2;
            width: 100%;
            overflow-wrap: break-word;
        }
        
        @media (max-width: 600px) {
            #instructions { padding: 20px; }
            .controls-info { grid-template-columns: 1fr; }
        }

        p {
            font-size: 16px;
            line-height: 1.6;
            color: #ccc;
        }

        /* Estilos para los controles */
        .controls-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            color: #fff;
            font-size: 14px;
        }

        .control-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 30px;
            text-align: center;
        }

        /* Loading Bar */
        #loading-bar-container {
            width: 100%;
            height: 4px;
            background: #333;
            margin-top: 20px;
            border-radius: 2px;
            overflow: hidden;
        }
        #loading-bar {
            width: 0%;
            height: 100%;
            background: #ffcc00;
            transition: width 0.3s;
        }

        .btn {
            background: transparent;
            border: 2px solid #fff;
            color: #fff;
            padding: 15px 40px;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 3px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
            font-weight: bold;
            opacity: 0.5;
            pointer-events: none;
        }
        
        .btn.active {
            opacity: 1;
            pointer-events: auto;
            background: #ffcc00;
            color: #000;
            border-color: #ffcc00;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px #ffcc00;
        }

        #crosshair {
            position: absolute;
            top: 50%; left: 50%;
            width: 8px; height: 8px;
            background: white; border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; z-index: 5;
            mix-blend-mode: difference;
        }

        #interact-msg {
            position: absolute;
            top: 60%; left: 50%;
            transform: translateX(-50%);
            font-size: 16px; color: #fff;
            background: rgba(0,0,0,0.6);
            padding: 8px 16px; border-radius: 20px;
            opacity: 0; transition: opacity 0.2s;
            pointer-events: none; z-index: 5;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Modales Comunes */
        .modal-overlay {
            display: none; position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            background: rgba(10,10,10,0.95);
            flex-direction: column; align-items: center; justify-content: center;
        }

        .modal-content-box {
            background: rgba(20, 20, 20, 0.98);
            border: 1px solid #444; padding: 40px;
            max-width: 90%; box-shadow: 0 0 50px black;
            position: relative;
        }

        #info-modal-box { width: 600px; }
        #info-modal h2 { color: #ffcc00; margin-top: 0; font-family: 'Orbitron', sans-serif; }
        #info-modal .close-btn { 
            position: absolute; top: 15px; right: 20px; 
            font-size: 24px; cursor: pointer; color: #666; background:none; border:none;
        }
        #info-modal .close-btn:hover { color: #fff; }
        
        #modal-content {
            font-size: 16px;
            line-height: 1.6;
            color: #ddd;
        }
        #modal-content b { color: #fff; }

        /* UI de Selecci√≥n Final */
        .card-container { display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap; justify-content: center; }
        .choice-card {
            background: #222; border: 1px solid #444; padding: 20px; width: 220px;
            cursor: pointer; transition: 0.3s; text-align: center;
        }
        .choice-card:hover { border-color: #ffcc00; transform: translateY(-5px); background: #333; }
        .choice-card h3 { color: #fff; margin: 10px 0; font-size: 18px; }

        /* UI de Cartel Final de Galer√≠a */
        #gallery-plaque-box {
            width: 800px;
            text-align: left;
            border: 2px solid #ffcc00;
            background: linear-gradient(to bottom, rgba(30,30,30,0.98), rgba(10,10,10,0.98));
        }
        #gallery-plaque h2 {
            font-family: 'Roboto Slab', serif;
            color: #ffcc00;
            font-size: 32px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 0;
            border-bottom: 1px solid #ffcc00;
            padding-bottom: 15px;
        }
        #gallery-plaque-content {
            font-family: 'Roboto Slab', serif;
            font-size: 18px;
            line-height: 1.8;
            color: #e0e0e0;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
</head>
<body>

    <!-- HUD GAMER -->
    <div id="hud-container">
        <div id="hud-title">OBJETIVOS DE INTELIGENCIA</div>
        <div id="hud-counter">0 / 9 ENCONTRADOS</div>
        <div id="hud-bar-bg"><div id="hud-bar-fill"></div></div>
    </div>

    <!-- NOTIFICACI√ìN DE SALIDA -->
    <div id="exit-notification">¬°SALIDA DESBLOQUEADA!</div>

    <div id="crosshair"></div>
    <div id="interact-msg">Click para interactuar</div>

    <!-- PANTALLA DE INICIO WEB -->
    <div id="blocker">
        <div id="instructions">
            <h1>La Galer√≠a de la Propaganda</h1>
            <p>
                Bienvenido, detective. La propaganda busca influir en tus emociones. 
                Tu misi√≥n es encontrar y analizar las <strong>9 pistas de persuasi√≥n</strong> ocultas en estas obras para desbloquear la salida.
            </p>
            
            <div class="controls-info">
                <div class="control-item"><span class="control-icon">‚å®Ô∏è</span> <div><strong>WASD / FLECHAS</strong><br><span style="font-size:12px; color:#aaa">Caminar</span></div></div>
                <div class="control-item"><span class="control-icon">üñ±Ô∏è</span> <div><strong>MOUSE</strong><br><span style="font-size:12px; color:#aaa">Mirar alrededor</span></div></div>
                <div class="control-item"><span class="control-icon">üëÜ</span> <div><strong>CLICK IZQUIERDO</strong><br><span style="font-size:12px; color:#aaa">Analizar pistas (+)</span></div></div>
                <div class="control-item"><span class="control-icon">üîì</span> <div><strong>TECLA ESC</strong><br><span style="font-size:12px; color:#aaa">Pausar / Mostrar mouse</span></div></div>
            </div>

            <div id="loading-bar-container">
                <div id="loading-bar"></div>
            </div>
            <p id="loading-text" style="font-size: 12px; color: #888; margin-top: 10px;">Cargando recursos...</p>

            <button class="btn" id="start-btn">ENTRAR AL MUSEO</button>
        </div>
    </div>

    <!-- MODAL INFO DE HOTSPOTS -->
    <div id="info-modal" class="modal-overlay" style="background: rgba(10,10,10,0.5);">
        <div class="modal-content-box" id="info-modal-box">
            <button class="close-btn">&times;</button>
            <h2 id="modal-title">T√≠tulo</h2>
            <div id="modal-content"></div>
            <button class="btn active" id="modal-close-main" style="margin-top:20px; width:100%; padding: 10px;">Cerrar</button>
        </div>
    </div>

    <!-- UI DE SELECCI√ìN FINAL -->
    <div id="final-selection-ui" class="modal-overlay">
        <div class="modal-content-box">
            <h1>An√°lisis Final</h1>
            <p>Has encontrado todas las pistas. ¬øQu√© pieza elegir√°s para tu an√°lisis profundo?</p>
            <div class="card-container">
                <div class="choice-card" onclick="showFinalExplanation('Rosie')">
                    <h3>Rosie the Riveter</h3><p style="font-size:12px; color:#888;">Propaganda de Guerra</p>
                </div>
                <div class="choice-card" onclick="showFinalExplanation('Cola')">
                    <h3>Destapa la Felicidad</h3><p style="font-size:12px; color:#888;">Propaganda Comercial</p>
                </div>
                <div class="choice-card" onclick="showFinalExplanation('Politica')">
                    <h3>Candidato Arturo</h3><p style="font-size:12px; color:#888;">Propaganda Pol√≠tica</p>
                </div>
            </div>
        </div>
    </div>

    <!-- UI DE CARTEL DE GALER√çA FINAL -->
    <div id="final-plaque-ui" class="modal-overlay">
        <div class="modal-content-box" id="gallery-plaque-box">
            <div id="gallery-plaque">
                <h2 id="plaque-title">T√≠tulo de la Obra</h2>
                <div id="plaque-content">Contenido explicativo...</div>
            </div>
            <button class="btn active" onclick="location.reload()" style="width: 100%; margin-top: 30px;">Reiniciar Recorrido</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE IM√ÅGENES LOCALES ---
        const IMG_URLS = {
            rosie: 'rosie.png', 
            coca: 'coca.png',
            politica: 'politica.png'
        };

        const FINAL_EXPLANATIONS = {
            'Rosie': `
                <strong>Tipo:</strong> Propaganda de Guerra y Movilizaci√≥n Nacional.<br><br>
                <strong>An√°lisis Profundo:</strong> Esta pieza es un ejemplo maestro de c√≥mo la propaganda puede redefinir roles sociales en tiempos de crisis. "Rosie" no solo vend√≠a un trabajo; vend√≠a una identidad patri√≥tica. Al fusionar feminidad con fuerza f√≠sica ("El M√∫sculo") y utilizar el pronombre colectivo "We" ("Nosotras"), transform√≥ el trabajo industrial, tradicionalmente masculino, en un deber c√≠vico y un acto de empoderamiento femenino esencial para la victoria nacional. No es informaci√≥n; es una llamada emocional a la acci√≥n colectiva frente a un enemigo com√∫n.
            `,
            'Cola': `
                <strong>Tipo:</strong> Propaganda Comercial y Asociaci√≥n Emocional.<br><br>
                <strong>An√°lisis Profundo:</strong> La publicidad moderna rara vez vende las caracter√≠sticas f√≠sicas del producto. En su lugar, vende intangibles. Esta pieza es un caso de libro de texto de condicionamiento emocional. Al eliminar casi cualquier referencia al sabor o ingredientes y centrarse exclusivamente en im√°genes de alegr√≠a social, juventud y pertenencia, la marca busca "secuestrar" estas emociones positivas. El objetivo es que, subconscientemente, el consumidor asocie la simple acci√≥n de abrir una botella con el acceso a un estado idealizado de felicidad y conexi√≥n humana.
            `,
            'Politica': `
                <strong>Tipo:</strong> Propaganda Pol√≠tica de Ataque y Polarizaci√≥n.<br><br>
                <strong>An√°lisis Profundo:</strong> Esta es la forma m√°s agresiva de persuasi√≥n: la "campa√±a negativa". Su objetivo no es promover las virtudes propias, sino destruir la imagen del oponente para disuadir el voto. Utiliza palabras gatillo como "PELIGRO" y "DESTRUIR" para inducir un estado de miedo y ansiedad, lo que a menudo anula el pensamiento cr√≠tico racional. La manipulaci√≥n visual (imagen oscura, granulada, rostro serio) est√° dise√±ada para evocar una respuesta visceral de desconfianza y rechazo antes de que el espectador pueda siquiera procesar cualquier argumento l√≥gico.
            `
        };

        // --- THREE.JS APP ---
        let camera, scene, renderer, controls, raycaster;
        let moveFwd = false, moveBwd = false, moveLeft = false, moveRight = false;
        let prevTime = performance.now();
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        
        let isModalOpen = false;
        let exitUnlocked = false;
        let exitMesh = null;
        let artMeshes = {}; 
        
        const hotspots = [];
        const totalSecrets = 9;
        let foundSecrets = new Set(); 

        const textureLoader = new THREE.TextureLoader();

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111111);
            scene.fog = new THREE.Fog(0x111111, 0, 40);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.y = 1.6;

            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            controls = new THREE.PointerLockControls(camera, document.body);

            preloadImages();

            const startBtn = document.getElementById('start-btn');
            startBtn.addEventListener('click', () => {
                if(startBtn.classList.contains('active')) {
                    controls.lock();
                }
            });

            controls.addEventListener('lock', () => {
                if(!isModalOpen && !exitUnlocked) document.getElementById('blocker').style.display = 'none';
            });
            controls.addEventListener('unlock', () => {
                if(!isModalOpen && !exitUnlocked) document.getElementById('blocker').style.display = 'flex';
            });

            const onKey = (e, val) => {
                switch(e.code) {
                    case 'KeyW': case 'ArrowUp': moveFwd = val; break;
                    case 'KeyS': case 'ArrowDown': moveBwd = val; break;
                    case 'KeyA': case 'ArrowLeft': moveLeft = val; break;
                    case 'KeyD': case 'ArrowRight': moveRight = val; break;
                }
            };
            document.addEventListener('keydown', (e) => onKey(e, true));
            document.addEventListener('keyup', (e) => onKey(e, false));

            raycaster = new THREE.Raycaster();
            document.addEventListener('mousedown', onMouseClick);
            
            document.querySelector('.close-btn').addEventListener('click', closeModal);
            document.getElementById('modal-close-main').addEventListener('click', closeModal);
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            buildWorld();
        }

        function preloadImages() {
            const keys = Object.keys(IMG_URLS);
            let total = keys.length;
            let current = 0;

            const updateProgress = () => {
                current++;
                const pct = (current / total) * 100;
                document.getElementById('loading-bar').style.width = pct + '%';
                if(current >= total) {
                    document.getElementById('loading-text').innerText = "¬°Listo para explorar!";
                    document.getElementById('start-btn').classList.add('active');
                }
            };

            keys.forEach(key => {
                textureLoader.load(IMG_URLS[key], (tex) => {
                    if(artMeshes[key]) artMeshes[key].material.map = tex;
                    updateProgress();
                }, undefined, () => updateProgress());
            });
        }

        function buildWorld() {
            // Suelo y Paredes
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(60,60), new THREE.MeshStandardMaterial({color: 0x222222, roughness: 0.8}));
            floor.rotation.x = -Math.PI/2; scene.add(floor);
            const wallMat = new THREE.MeshStandardMaterial({color: 0x333333});
            createWall(0, 3, -10, 20, 6, 1, wallMat); createWall(0, 3, 10, 20, 6, 1, wallMat);
            createWall(-10, 3, 0, 1, 6, 20, wallMat); createWall(10, 3, 0, 1, 6, 20, wallMat);
            createWall(0, 6, 0, 20, 1, 20, new THREE.MeshBasicMaterial({color:0x050505}));

            // Luces Techo
            const lightGeo = new THREE.CylinderGeometry(0.2, 0.1, 0.2, 16);
            const lightMat = new THREE.MeshBasicMaterial({color: 0xffffcc});
            for(let x = -8; x <= 8; x += 8) {
                for(let z = -8; z <= 8; z += 8) {
                    const fixture = new THREE.Mesh(lightGeo, lightMat);
                    fixture.position.set(x, 5.9, z); scene.add(fixture);
                    const ptLight = new THREE.PointLight(0xffffcc, 0.3, 10);
                    ptLight.position.set(x, 5.5, z); scene.add(ptLight);
                }
            }

            // OBRAS & HOTSPOTS & ETIQUETAS
            
            // 1. Rosie
            createArtDisplay({ text: "We Can Do It!", color: "#FFCC00" }, new THREE.Vector3(-9.4, 2, -5), Math.PI/2, 'rosie', {w:2.2, h:3});
            createLabel("PROPAGANDA DE GUERRA", new THREE.Vector3(-9.4, 4.0, -5), Math.PI/2);
            
            // Puntos de info detallados (RESTAURADOS Y MEJORADOS)
            createHotspot(new THREE.Vector3(-9, 2.5, -5.5), "El M√∫sculo", "Esta mujer no es fr√°gil: es fuerte. El gesto del brazo flexionado se convirti√≥ en un s√≠mbolo universal de poder femenino en un entorno industrial, desafiando roles tradicionales.", 1);
            createHotspot(new THREE.Vector3(-9, 3.2, -5), "El Lema", "El uso de 'We' (Nosotras) crea unidad. No dice 'You can do it', dice 'NOSOTRAS podemos', implicando solidaridad, esfuerzo colectivo y deber patri√≥tico.", 2);
            createHotspot(new THREE.Vector3(-9, 1.5, -4.5), "Contexto (IEEAS)", "<b>Intenci√≥n:</b> Reclutar mano de obra femenina en f√°bricas.<br><b>Emoci√≥n:</b> Orgullo, capacidad y autoeficacia.<br><b>Contexto:</b> Escasez de hombres durante la Segunda Guerra Mundial.", 3);

            // 2. Coca-Cola
            createArtDisplay({ text: "DESTAPA FELICIDAD", color: "#CC0000" }, new THREE.Vector3(0, 2, -9.4), 0, 'coca', {w:2.5, h:3.5});
            createLabel("PROPAGANDA COMERCIAL", new THREE.Vector3(0, 4.2, -9.4), 0);

            createHotspot(new THREE.Vector3(-0.8, 2.5, -9), "Fiesta y Confeti", "La imagen muestra celebraci√≥n y amigos. No te venden una bebida azucarada, te venden la experiencia de ser aceptado y ser el alma de la fiesta.", 4);
            createHotspot(new THREE.Vector3(0.8, 1.5, -9), "El Brindis", "Todos conectan sus botellas en el centro. El producto es presentado como el nexo de uni√≥n indispensable que hace posible la amistad y los momentos felices.", 5);
            createHotspot(new THREE.Vector3(0, 1, -9), "Contexto", "<b>Intenci√≥n:</b> Vincular consumo con felicidad social.<br><b>T√©cnica:</b> Transferencia (asociar sentimientos positivos de un grupo al producto).", 6);

            // 3. Pol√≠tica
            createArtDisplay({ text: "¬°PELIGRO: ARTURO!", color: "#550000" }, new THREE.Vector3(9.4, 2, 5), -Math.PI/2, 'politica', {w:2.2, h:3.2});
            createLabel("PROPAGANDA POL√çTICA", new THREE.Vector3(9.4, 4.0, 5), -Math.PI/2);

            createHotspot(new THREE.Vector3(9, 3, 5), "¬°DESTRUYA TU FUTURO!", "El uso de may√∫sculas y palabras alarmistas ('Peligro', 'Arruinar√°n') busca paralizar el pensamiento racional activando el miedo inmediato.", 7);
            createHotspot(new THREE.Vector3(9, 2, 5.5), "El Rostro de Arturo", "La foto en blanco y negro, granulada y seria, est√° editada intencionalmente para que el candidato parezca siniestro, antiguo, amenazante o poco confiable.", 8);
            createHotspot(new THREE.Vector3(9, 1.2, 4.5), "Contexto", "<b>Intenci√≥n:</b> Disuadir el voto hacia el oponente.<br><b>Emoci√≥n:</b> Miedo a la p√©rdida econ√≥mica y seguridad.<br><b>T√©cnica:</b> Campa√±a de ataque o 'mudslinging'.", 9);

            createExit();
        }

        function createWall(x,y,z,w,h,d,mat) {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), mat);
            mesh.position.set(x,y,z); scene.add(mesh);
        }

        function createArtDisplay(fallbackData, pos, rotY, id, size) {
            const frame = new THREE.Mesh(new THREE.BoxGeometry(size.w+0.2, size.h+0.2, 0.1), new THREE.MeshStandardMaterial({color:0x111111}));
            frame.position.copy(pos); frame.rotation.y = rotY; scene.add(frame);
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 700;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = fallbackData.color; ctx.fillRect(0,0,512,700);
            ctx.fillStyle = "white"; ctx.font="bold 40px Arial"; ctx.textAlign="center"; ctx.fillText(fallbackData.text, 256, 350);
            const tex = new THREE.CanvasTexture(canvas);
            const mesh = new THREE.Mesh(new THREE.PlaneGeometry(size.w, size.h), new THREE.MeshBasicMaterial({map: tex}));
            mesh.position.copy(pos); mesh.rotation.y = rotY; mesh.position.add(new THREE.Vector3(0,0,0.06).applyAxisAngle(new THREE.Vector3(0,1,0), rotY));
            scene.add(mesh);
            artMeshes[id] = mesh;
            const spot = new THREE.SpotLight(0xffffff, 2);
            spot.position.set(pos.x - Math.sin(rotY)*4, 5, pos.z + Math.cos(rotY)*4);
            spot.target = mesh; spot.angle = 0.5; spot.penumbra = 0.5; scene.add(spot);
        }

        // --- FUNCI√ìN MEJORADA: Etiquetas 3D de alta resoluci√≥n ---
        function createLabel(text, pos, rotY) {
            const canvas = document.createElement('canvas');
            // Aumentamos resoluci√≥n para evitar cortes en textos largos
            canvas.width = 1024; 
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            // Fondo semitransparente oscuro
            ctx.fillStyle = "rgba(0,0,0,0.7)";
            ctx.fillRect(0,0,1024,256);
            
            // Borde inferior
            ctx.strokeStyle = "#ffcc00";
            ctx.lineWidth = 15;
            ctx.beginPath(); ctx.moveTo(0, 256); ctx.lineTo(1024, 256); ctx.stroke();
            
            // Texto (tama√±o ajustado al nuevo canvas)
            ctx.font = "bold 60px Arial";
            ctx.fillStyle = "#ffffff";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(text, 512, 128); // Centrado en 1024/2 = 512

            const tex = new THREE.CanvasTexture(canvas);
            // IMPORTANTE: Filtrado lineal para que se vea suave aunque sea grande
            tex.minFilter = THREE.LinearFilter;
            
            const mat = new THREE.MeshBasicMaterial({map: tex, transparent: true});
            // Mantenemos el tama√±o f√≠sico en el mundo igual
            const mesh = new THREE.Mesh(new THREE.PlaneGeometry(3, 0.75), mat);
            mesh.position.copy(pos);
            mesh.rotation.y = rotY;
            scene.add(mesh);
        }

        function createHotspot(pos, title, desc, id) {
            const mesh = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({color: 0x00ffcc}));
            mesh.position.copy(pos); 
            mesh.userData = {type:'hotspot', title, desc, id: id};
            scene.add(mesh); 
            hotspots.push(mesh); 
        }

        function createExit() {
            const geo = new THREE.BoxGeometry(2,3,0.1);
            const mat = new THREE.MeshStandardMaterial({color: 0x00ff00, emissive: 0x00ff00, emissiveIntensity: 0.5});
            exitMesh = new THREE.Mesh(geo, mat);
            exitMesh.position.set(0, 1.5, 9);
            exitMesh.visible = false;
            exitMesh.userData = {type:'exit'};
            scene.add(exitMesh);
        }

        // --- L√ìGICA DE INTERACCI√ìN ---
        function onMouseClick() {
            if(!controls.isLocked) return;
            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = raycaster.intersectObjects(scene.children);
            if(hits.length > 0) {
                const obj = hits[0].object;
                if(obj.userData.type === 'hotspot') {
                    openModal(obj.userData.title, obj.userData.desc);
                    
                    if(!foundSecrets.has(obj.userData.id)) {
                        foundSecrets.add(obj.userData.id);
                        updateHUD();
                        obj.material.color.setHex(0x555555);
                    }
                    checkExit();
                    
                } else if(obj.userData.type === 'exit' && exitMesh.visible) {
                    document.exitPointerLock();
                    document.getElementById('blocker').style.display = 'none';
                    document.getElementById('final-selection-ui').style.display = 'flex';
                    exitUnlocked = true;
                }
            }
        }

        function updateHUD() {
            const count = foundSecrets.size;
            document.getElementById('hud-counter').innerText = `${count} / ${totalSecrets} ENCONTRADOS`;
            const pct = (count / totalSecrets) * 100;
            document.getElementById('hud-bar-fill').style.width = pct + '%';
        }

        function checkExit() {
            if(foundSecrets.size === totalSecrets) {
                if(!exitMesh.visible) {
                    exitMesh.visible = true;
                    const notif = document.getElementById('exit-notification');
                    notif.style.opacity = 1;
                    setTimeout(() => { notif.style.opacity = 0; }, 4000);
                }
            }
        }

        function openModal(title, content) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('info-modal').style.display = 'flex';
            isModalOpen = true;
            document.exitPointerLock();
        }

        function closeModal() {
            document.getElementById('info-modal').style.display = 'none';
            isModalOpen = false;
            controls.lock();
        }

        window.showFinalExplanation = (choiceKey) => {
            const titleMap = { 'Rosie': 'Rosie the Riveter', 'Cola': 'Destapa la Felicidad', 'Politica': 'Candidato Arturo' };
            document.getElementById('final-selection-ui').style.display = 'none';
            document.getElementById('plaque-title').innerText = titleMap[choiceKey];
            document.getElementById('plaque-content').innerHTML = FINAL_EXPLANATIONS[choiceKey];
            document.getElementById('final-plaque-ui').style.display = 'flex';
        };

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            
            if(exitMesh && exitMesh.visible) {
                exitMesh.rotation.y = Math.sin(time * 0.001) * 0.2;
                exitMesh.material.emissiveIntensity = 0.5 + Math.sin(time * 0.003) * 0.3;
            }

            hotspots.forEach(h => {
                if(!foundSecrets.has(h.userData.id)) {
                    const scale = 1 + Math.sin(time * 0.005) * 0.2;
                    h.scale.set(scale, scale, scale);
                } else {
                    h.scale.set(1,1,1);
                }
            });

            if(controls.isLocked) {
                const delta = (time - prevTime) / 1000;
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                direction.z = Number(moveFwd) - Number(moveBwd);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                if (moveFwd || moveBwd) velocity.z -= direction.z * 40.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 40.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
                const hits = raycaster.intersectObjects(scene.children);
                const msg = document.getElementById('interact-msg');
                let hover = false;
                if(hits.length > 0 && hits[0].distance < 4) {
                    if(hits[0].object.userData.type === 'hotspot') hover = true;
                    if(hits[0].object.userData.type === 'exit' && exitMesh.visible) {
                        hover = true; msg.innerText = "Click para SALIR";
                    } else msg.innerText = "Click para interactuar";
                }
                msg.style.opacity = hover ? 1 : 0;
            }
            prevTime = time;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>